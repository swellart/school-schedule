<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Schedule Coordinator</title>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <!-- Lucide Icons -->
    <script>
        // Simple icon components as inline SVGs
        window.LucideIcons = {
            Plus: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',
            Trash2: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>',
            AlertCircle: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>',
            Calendar: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>',
            Download: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',
            Upload: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>',
            FileSpreadsheet: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',
            Check: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>'
        };
    </script>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

        // Load saved data from localStorage
        const loadFromLocalStorage = (key, defaultValue) => {
          try {
            const saved = localStorage.getItem(key);
            return saved ? JSON.parse(saved) : defaultValue;
          } catch (error) {
            console.error('Error loading from localStorage:', error);
            return defaultValue;
          }
        };

        // Save data to localStorage
        const saveToLocalStorage = (key, value) => {
          try {
            localStorage.setItem(key, JSON.stringify(value));
          } catch (error) {
            console.error('Error saving to localStorage:', error);
          }
        };

        // Icon component
        const Icon = ({ name, size = 24, className = '' }) => {
            const svgString = window.LucideIcons[name] || '';
            return (
                <span 
                    className={`inline-block ${className}`}
                    style={{ width: size, height: size }}
                    dangerouslySetInnerHTML={{ __html: svgString }}
                />
            );
        };

        function SchoolScheduler() {
          const [classrooms, setClassrooms] = useState(() => 
            loadFromLocalStorage('classrooms', [
              { id: 1, name: 'Room 101' },
              { id: 2, name: 'Room 102' }
            ])
          );
          
          const [timeSlots, setTimeSlots] = useState(() => 
            loadFromLocalStorage('timeSlots', [
              { id: 1, start: '08:00', end: '09:00' },
              { id: 2, start: '09:00', end: '10:00' },
              { id: 3, start: '10:00', end: '11:00' },
              { id: 4, start: '11:00', end: '12:00' }
            ])
          );
          
          const [subjects, setSubjects] = useState(() => 
            loadFromLocalStorage('subjects', [
              { 
                id: 1, 
                name: 'Mathematics', 
                teacher: 'Mr. Smith',
                group: 'Grade 10A',
                color: '#3b82f6',
                constraints: {
                  requiredDays: [],
                  requiredSlots: [],
                  requiredClassroom: null,
                  preferredDays: [],
                  preferredSlots: [],
                  preferredClassroom: null,
                  unavailableDays: [],
                  unavailableSlots: [],
                  maxPerDay: 2,
                  daysPerWeek: 1,
                  canCombineWith: [],
                }
              }
            ])
          );
          
          const [schedule, setSchedule] = useState(() => loadFromLocalStorage('schedule', {}));
          const [activeTab, setActiveTab] = useState('schedule');
          const [newClassroom, setNewClassroom] = useState('');
          const [newSubject, setNewSubject] = useState({ 
            name: '', 
            teacher: '', 
            group: '',
            color: '#3b82f6' 
          });
          const [editingSubject, setEditingSubject] = useState(null);
          const [draggedSubject, setDraggedSubject] = useState(null);
          const [viewMode, setViewMode] = useState('grid'); // 'grid' or 'kanban'
          const [editingTimeSlot, setEditingTimeSlot] = useState(null);
          const [newTimeSlot, setNewTimeSlot] = useState({ start: '08:00', end: '09:00' });
          const [aiApiKey, setAiApiKey] = useState(() => loadFromLocalStorage('claude_api_key', ''));
          const [aiCommand, setAiCommand] = useState('');
          const [aiResponse, setAiResponse] = useState(null);
          const [aiLoading, setAiLoading] = useState(false);
          const [showApiKeyInput, setShowApiKeyInput] = useState(false);

          // Auto-save to localStorage whenever data changes
          useEffect(() => {
            saveToLocalStorage('classrooms', classrooms);
          }, [classrooms]);

          useEffect(() => {
            saveToLocalStorage('timeSlots', timeSlots);
          }, [timeSlots]);

          useEffect(() => {
            saveToLocalStorage('subjects', subjects);
          }, [subjects]);

          useEffect(() => {
            saveToLocalStorage('schedule', schedule);
          }, [schedule]);

          useEffect(() => {
            if (aiApiKey) {
              saveToLocalStorage('claude_api_key', aiApiKey);
            }
          }, [aiApiKey]);

          const addClassroom = () => {
            if (newClassroom.trim()) {
              setClassrooms([...classrooms, { 
                id: Date.now(), 
                name: newClassroom.trim() 
              }]);
              setNewClassroom('');
            }
          };

          const removeClassroom = (id) => {
            setClassrooms(classrooms.filter(c => c.id !== id));
            const newSchedule = { ...schedule };
            Object.keys(newSchedule).forEach(key => {
              if (key.startsWith(`${id}-`)) {
                delete newSchedule[key];
              }
            });
            setSchedule(newSchedule);
          };

          const addTimeSlot = () => {
            if (newTimeSlot.start && newTimeSlot.end) {
              setTimeSlots([...timeSlots, { 
                id: Date.now(), 
                start: newTimeSlot.start, 
                end: newTimeSlot.end 
              }]);
              // Auto-increment for next slot
              const [hours, mins] = newTimeSlot.end.split(':').map(Number);
              const nextEnd = `${String(hours + 1).padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
              setNewTimeSlot({ start: newTimeSlot.end, end: nextEnd });
            }
          };

          const updateTimeSlot = (id, start, end) => {
            setTimeSlots(timeSlots.map(t => 
              t.id === id ? { ...t, start, end } : t
            ));
          };

          const removeTimeSlot = (id) => {
            setTimeSlots(timeSlots.filter(t => t.id !== id));
            const newSchedule = { ...schedule };
            Object.keys(newSchedule).forEach(key => {
              if (key.endsWith(`-${id}`)) {
                delete newSchedule[key];
              }
            });
            setSchedule(newSchedule);
          };

          const addSubject = () => {
            if (newSubject.name.trim() && newSubject.teacher.trim()) {
              setSubjects([...subjects, {
                id: Date.now(),
                name: newSubject.name.trim(),
                teacher: newSubject.teacher.trim(),
                group: newSubject.group.trim(),
                color: newSubject.color,
                constraints: {
                  requiredDays: [],
                  requiredSlots: [],
                  requiredClassroom: null,
                  preferredDays: [],
                  preferredSlots: [],
                  preferredClassroom: null,
                  unavailableDays: [],
                  unavailableSlots: [],
                  maxPerDay: 2,
                  daysPerWeek: 1,
                  canCombineWith: [],
                }
              }]);
              setNewSubject({ name: '', teacher: '', group: '', color: '#3b82f6' });
            }
          };

          const removeSubject = (id) => {
            setSubjects(subjects.filter(s => s.id !== id));
            const newSchedule = { ...schedule };
            Object.keys(newSchedule).forEach(key => {
              if (newSchedule[key] && newSchedule[key].subjectId === id) {
                delete newSchedule[key];
              }
            });
            setSchedule(newSchedule);
          };

          const updateSubjectConstraints = (subjectId, constraints) => {
            setSubjects(subjects.map(s => 
              s.id === subjectId ? { ...s, constraints } : s
            ));
          };

          const getScheduleKey = (classroomId, day, slotId) => {
            return `${classroomId}-${day}-${slotId}`;
          };

          const checkConflicts = (classroomId, day, slotId, subjectId) => {
            const conflicts = [];
            const warnings = [];
            const subject = subjects.find(s => s.id === subjectId);
            
            if (!subject) return { conflicts, warnings };

            Object.entries(schedule).forEach(([key, value]) => {
              if (value.subjectId === subjectId && key !== getScheduleKey(classroomId, day, slotId)) {
                const parts = key.split('-');
                const schedDay = parts[1];
                const schedSlot = parts[2];
                if (schedDay === day && schedSlot === String(slotId)) {
                  conflicts.push('Teacher already scheduled at this time');
                }
              }
            });

            if (subject.constraints.requiredDays.length > 0 && !subject.constraints.requiredDays.includes(day)) {
              conflicts.push('Must be on: ' + subject.constraints.requiredDays.join(', '));
            }
            if (subject.constraints.requiredSlots.length > 0 && !subject.constraints.requiredSlots.includes(slotId)) {
              const requiredTimes = subject.constraints.requiredSlots
                .map(sid => timeSlots.find(ts => ts.id === sid))
                .filter(Boolean)
                .map(ts => ts.start + '-' + ts.end)
                .join(', ');
              conflicts.push('Must be at: ' + requiredTimes);
            }
            if (subject.constraints.requiredClassroom && subject.constraints.requiredClassroom !== classroomId) {
              const reqRoom = classrooms.find(c => c.id === subject.constraints.requiredClassroom);
              conflicts.push('Must be in: ' + (reqRoom ? reqRoom.name : 'specified room'));
            }

            if (subject.constraints.unavailableDays.includes(day)) {
              conflicts.push('Subject unavailable on this day');
            }
            if (subject.constraints.unavailableSlots.includes(slotId)) {
              conflicts.push('Subject unavailable at this time');
            }

            if (subject.constraints.preferredDays.length > 0 && !subject.constraints.preferredDays.includes(day)) {
              warnings.push('Preferred days: ' + subject.constraints.preferredDays.join(', '));
            }
            if (subject.constraints.preferredSlots.length > 0 && !subject.constraints.preferredSlots.includes(slotId)) {
              const preferredTimes = subject.constraints.preferredSlots
                .map(sid => timeSlots.find(ts => ts.id === sid))
                .filter(Boolean)
                .map(ts => ts.start + '-' + ts.end)
                .join(', ');
              warnings.push('Preferred times: ' + preferredTimes);
            }
            if (subject.constraints.preferredClassroom && subject.constraints.preferredClassroom !== classroomId) {
              const prefRoom = classrooms.find(c => c.id === subject.constraints.preferredClassroom);
              warnings.push('Preferred room: ' + (prefRoom ? prefRoom.name : 'other room'));
            }

            const dayCount = Object.entries(schedule).filter(([key, value]) => {
              const parts = key.split('-');
              const schedDay = parts[1];
              return schedDay === day && value.subjectId === subjectId;
            }).length;
            
            if (dayCount >= subject.constraints.maxPerDay) {
              conflicts.push('Max ' + subject.constraints.maxPerDay + ' classes per day exceeded');
            }

            return { conflicts, warnings };
          };

          const getSubjectScheduleSummary = (subjectId) => {
            const uniqueDays = new Set();
            Object.entries(schedule).forEach(([key, value]) => {
              if (value.subjectId === subjectId) {
                const parts = key.split('-');
                uniqueDays.add(parts[1]);
              }
            });
            return {
              scheduledDays: uniqueDays.size,
              days: Array.from(uniqueDays)
            };
          };

          const handleDrop = (classroomId, day, slotId) => {
            if (!draggedSubject) return;
            
            const result = checkConflicts(classroomId, day, slotId, draggedSubject.id);
            
            if (result.conflicts.length === 0) {
              const key = getScheduleKey(classroomId, day, slotId);
              setSchedule({
                ...schedule,
                [key]: {
                  subjectId: draggedSubject.id,
                  subjectName: draggedSubject.name,
                  teacher: draggedSubject.teacher,
                  group: draggedSubject.group,
                  color: draggedSubject.color
                }
              });
            }
            
            setDraggedSubject(null);
          };

          const removeScheduleItem = (classroomId, day, slotId) => {
            const key = getScheduleKey(classroomId, day, slotId);
            const newSchedule = { ...schedule };
            delete newSchedule[key];
            setSchedule(newSchedule);
          };

          const exportToCSV = (data, filename) => {
            const csv = data.map(row => row.map(cell => {
              const cellStr = String(cell);
              if (cellStr.includes(',') || cellStr.includes('"')) {
                return '"' + cellStr.replace(/"/g, '""') + '"';
              }
              return cellStr;
            }).join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
          };

          const exportClassroomsCSV = () => {
            const data = [
              ['ID', 'Name'],
              ...classrooms.map(c => [c.id, c.name])
            ];
            exportToCSV(data, 'classrooms.csv');
          };

          const exportTimeSlotsCSV = () => {
            const data = [
              ['ID', 'Start Time', 'End Time'],
              ...timeSlots.map(t => [t.id, t.start, t.end])
            ];
            exportToCSV(data, 'time_slots.csv');
          };

          const exportSubjectsCSV = () => {
            const data = [
              ['ID', 'Subject', 'Teacher', 'Group/Class', 'Color', 'Required Days', 'Required Time Slots', 'Required Classroom', 
               'Preferred Days', 'Preferred Time Slots', 'Preferred Classroom', 'Unavailable Days', 'Unavailable Time Slots', 
               'Max Per Day', 'Days Per Week', 'Can Combine With'],
              ...subjects.map(s => [
                s.id,
                s.name,
                s.teacher,
                s.group,
                s.color,
                s.constraints.requiredDays.join(';'),
                s.constraints.requiredSlots.join(';'),
                s.constraints.requiredClassroom || '',
                s.constraints.preferredDays.join(';'),
                s.constraints.preferredSlots.join(';'),
                s.constraints.preferredClassroom || '',
                s.constraints.unavailableDays.join(';'),
                s.constraints.unavailableSlots.join(';'),
                s.constraints.maxPerDay,
                s.constraints.daysPerWeek,
                s.constraints.canCombineWith.join(';')
              ])
            ];
            exportToCSV(data, 'subjects_teachers.csv');
          };

          const exportScheduleCSV = () => {
            const data = [
              ['Classroom ID', 'Classroom', 'Day', 'Time Slot ID', 'Time', 'Subject ID', 'Subject', 'Teacher', 'Group/Class'],
              ...Object.entries(schedule).map(([key, value]) => {
                const parts = key.split('-');
                const classroomId = parts[0];
                const day = parts[1];
                const slotId = parts[2];
                const classroom = classrooms.find(c => c.id === parseInt(classroomId));
                const slot = timeSlots.find(t => t.id === parseInt(slotId));
                return [
                  classroomId,
                  classroom ? classroom.name : '',
                  day,
                  slotId,
                  slot ? slot.start + '-' + slot.end : '',
                  value.subjectId,
                  value.subjectName,
                  value.teacher,
                  value.group || ''
                ];
              })
            ];
            exportToCSV(data, 'schedule.csv');
          };

          const importFromCSV = (file, type) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              let text = e.target.result;
              
              // Normalize line endings (handle Windows, Mac, Linux, Google Sheets)
              text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
              
              const rows = text.split('\n').map(row => {
                // Skip empty rows
                if (!row.trim()) return [];
                
                const cells = [];
                let cell = '';
                let inQuotes = false;
                
                for (let i = 0; i < row.length; i++) {
                  const char = row[i];
                  if (char === '"') {
                    if (inQuotes && row[i + 1] === '"') {
                      // Handle escaped quotes ("")
                      cell += '"';
                      i++; // Skip next quote
                    } else {
                      inQuotes = !inQuotes;
                    }
                  } else if (char === ',' && !inQuotes) {
                    cells.push(cell.trim());
                    cell = '';
                  } else {
                    cell += char;
                  }
                }
                cells.push(cell.trim());
                return cells;
              }).filter(row => row.length > 0 && row.some(cell => cell));

              if (rows.length < 2) return;

              const data = rows.slice(1);

              if (type === 'classrooms') {
                const imported = data.map(row => ({
                  id: parseInt(row[0]) || Date.now() + Math.random(),
                  name: row[1] || 'Unnamed'
                }));
                setClassrooms(imported);
              } else if (type === 'timeSlots') {
                const imported = data.map(row => ({
                  id: parseInt(row[0]) || Date.now() + Math.random(),
                  start: row[1] || '08:00',
                  end: row[2] || '09:00'
                }));
                setTimeSlots(imported);
              } else if (type === 'subjects') {
                const imported = data.map(row => ({
                  id: parseInt(row[0]) || Date.now() + Math.random(),
                  name: row[1] || 'Unnamed',
                  teacher: row[2] || '',
                  group: row[3] || '',
                  color: row[4] || '#3b82f6',
                  constraints: {
                    requiredDays: row[5] ? row[5].split(';').filter(Boolean) : [],
                    requiredSlots: row[6] ? row[6].split(';').map(Number).filter(Boolean) : [],
                    requiredClassroom: row[7] ? parseInt(row[7]) : null,
                    preferredDays: row[8] ? row[8].split(';').filter(Boolean) : [],
                    preferredSlots: row[9] ? row[9].split(';').map(Number).filter(Boolean) : [],
                    preferredClassroom: row[10] ? parseInt(row[10]) : null,
                    unavailableDays: row[11] ? row[11].split(';').filter(Boolean) : [],
                    unavailableSlots: row[12] ? row[12].split(';').map(Number).filter(Boolean) : [],
                    maxPerDay: parseInt(row[13]) || 2,
                    daysPerWeek: parseInt(row[14]) || 1,
                    canCombineWith: row[15] ? row[15].split(';').map(Number).filter(Boolean) : []
                  }
                }));
                setSubjects(imported);
              }
            };
            reader.readAsText(file);
          };

          const importScheduleFromCSV = (file) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              let text = e.target.result;
              
              // Normalize line endings
              text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
              
              const rows = text.split('\n').map(row => {
                if (!row.trim()) return [];
                
                const cells = [];
                let cell = '';
                let inQuotes = false;
                
                for (let i = 0; i < row.length; i++) {
                  const char = row[i];
                  if (char === '"') {
                    if (inQuotes && row[i + 1] === '"') {
                      cell += '"';
                      i++;
                    } else {
                      inQuotes = !inQuotes;
                    }
                  } else if (char === ',' && !inQuotes) {
                    cells.push(cell.trim());
                    cell = '';
                  } else {
                    cell += char;
                  }
                }
                cells.push(cell.trim());
                return cells;
              }).filter(row => row.length > 0 && row.some(cell => cell));

              if (rows.length < 2) {
                alert('CSV file is empty or invalid');
                return;
              }

              const headers = rows[0];
              const data = rows.slice(1);

              // Expected format: Classroom,Day,Time Slot,Subject,Teacher,Group/Class
              // OR: Classroom ID,Classroom,Day,Time Slot ID,Time,Subject ID,Subject,Teacher,Group/Class
              
              const newSchedule = {};
              let importedCount = 0;
              let skippedCount = 0;

              data.forEach(row => {
                // Support both simple and detailed formats
                let classroomName, day, timeSlot, subjectName, teacher, group;
                
                if (row.length >= 6) {
                  // Simple format: Classroom,Day,Time Slot,Subject,Teacher,Group/Class
                  if (headers[0] === 'Classroom' && headers[1] === 'Day') {
                    classroomName = row[0];
                    day = row[1];
                    timeSlot = row[2]; // e.g., "08:00-09:00"
                    subjectName = row[3];
                    teacher = row[4];
                    group = row[5] || '';
                  } 
                  // Detailed format (from export): Classroom ID,Classroom,Day,Time Slot ID,Time,Subject ID,Subject,Teacher,Group/Class
                  else if (row.length >= 9) {
                    classroomName = row[1];
                    day = row[2];
                    timeSlot = row[4];
                    subjectName = row[6];
                    teacher = row[7];
                    group = row[8] || '';
                  }
                }

                if (!classroomName || !day || !timeSlot || !subjectName) {
                  skippedCount++;
                  return;
                }

                // Find matching classroom
                const classroom = classrooms.find(c => 
                  c.name.toLowerCase() === classroomName.toLowerCase()
                );

                if (!classroom) {
                  skippedCount++;
                  console.warn('Classroom not found:', classroomName);
                  return;
                }

                // Find matching time slot
                const slot = timeSlots.find(ts => {
                  const slotTime = ts.start + '-' + ts.end;
                  return slotTime === timeSlot || ts.start === timeSlot.split('-')[0];
                });

                if (!slot) {
                  skippedCount++;
                  console.warn('Time slot not found:', timeSlot);
                  return;
                }

                // Find or create subject
                let subject = subjects.find(s => 
                  s.name.toLowerCase() === subjectName.toLowerCase() && 
                  s.teacher.toLowerCase() === teacher.toLowerCase()
                );

                if (!subject) {
                  // Auto-create subject if it doesn't exist
                  const newSubjectId = Date.now() + Math.random();
                  const newSubject = {
                    id: newSubjectId,
                    name: subjectName,
                    teacher: teacher,
                    group: group,
                    color: '#' + Math.floor(Math.random()*16777215).toString(16),
                    constraints: {
                      requiredDays: [],
                      requiredSlots: [],
                      requiredClassroom: null,
                      preferredDays: [],
                      preferredSlots: [],
                      preferredClassroom: null,
                      unavailableDays: [],
                      unavailableSlots: [],
                      maxPerDay: 2,
                      daysPerWeek: 1,
                      canCombineWith: [],
                    }
                  };
                  subjects.push(newSubject);
                  subject = newSubject;
                }

                // Add to schedule
                const key = getScheduleKey(classroom.id, day, slot.id);
                newSchedule[key] = {
                  subjectId: subject.id,
                  subjectName: subject.name,
                  teacher: subject.teacher,
                  group: subject.group || group,
                  color: subject.color
                };
                importedCount++;
              });

              setSchedule(newSchedule);
              setSubjects([...subjects]); // Update subjects state if we added any
              
              alert(`Schedule imported successfully!\n\nImported: ${importedCount} classes\nSkipped: ${skippedCount} entries\n\n${skippedCount > 0 ? 'Some entries were skipped. Check that classroom names and time slots match your settings.' : ''}`);
            };
            reader.readAsText(file);
          };

          const exportSchedule = () => {
            const data = {
              classrooms,
              timeSlots,
              subjects,
              schedule
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'school-schedule.json';
            a.click();
          };

          const autoSchedule = () => {
            const newSchedule = { ...schedule };
            const unscheduledSubjects = [...subjects];
            let successCount = 0;
            let failCount = 0;

            unscheduledSubjects.sort((a, b) => {
              const aConstraints = a.constraints.requiredDays.length + 
                                  a.constraints.requiredSlots.length + 
                                  (a.constraints.requiredClassroom ? 1 : 0);
              const bConstraints = b.constraints.requiredDays.length + 
                                  b.constraints.requiredSlots.length + 
                                  (b.constraints.requiredClassroom ? 1 : 0);
              return bConstraints - aConstraints;
            });

            for (const subject of unscheduledSubjects) {
              const currentScheduledCount = Object.values(newSchedule).filter(
                item => item.subjectId === subject.id
              ).length;

              const attempts = Math.max(1, 3 - currentScheduledCount);
              
              for (let attempt = 0; attempt < attempts; attempt++) {
                let scheduled = false;

                const possibleClassrooms = subject.constraints.requiredClassroom
                  ? [classrooms.find(c => c.id === subject.constraints.requiredClassroom)]
                  : classrooms;

                const possibleDays = subject.constraints.requiredDays.length > 0
                  ? subject.constraints.requiredDays
                  : DAYS.filter(day => !subject.constraints.unavailableDays.includes(day));

                const possibleSlots = subject.constraints.requiredSlots.length > 0
                  ? timeSlots.filter(slot => subject.constraints.requiredSlots.includes(slot.id))
                  : timeSlots.filter(slot => !subject.constraints.unavailableSlots.includes(slot.id));

                const daysToTry = subject.constraints.preferredDays.length > 0
                  ? [...subject.constraints.preferredDays, ...possibleDays.filter(d => !subject.constraints.preferredDays.includes(d))]
                  : possibleDays;

                const slotsToTry = subject.constraints.preferredSlots.length > 0
                  ? [...timeSlots.filter(s => subject.constraints.preferredSlots.includes(s.id)), 
                     ...possibleSlots.filter(s => !subject.constraints.preferredSlots.includes(s.id))]
                  : possibleSlots;

                for (const classroom of possibleClassrooms) {
                  if (!classroom) continue;
                  
                  for (const day of daysToTry) {
                    for (const slot of slotsToTry) {
                      const key = getScheduleKey(classroom.id, day, slot.id);
                      
                      if (newSchedule[key]) continue;

                      const result = checkConflicts(classroom.id, day, slot.id, subject.id);
                      
                      if (result.conflicts.length === 0) {
                        newSchedule[key] = {
                          subjectId: subject.id,
                          subjectName: subject.name,
                          teacher: subject.teacher,
                          group: subject.group,
                          color: subject.color
                        };
                        scheduled = true;
                        successCount++;
                        break;
                      }
                    }
                    if (scheduled) break;
                  }
                  if (scheduled) break;
                }

                if (!scheduled) {
                  failCount++;
                  break;
                }
              }
            }

            setSchedule(newSchedule);
            return { successCount, failCount };
          };

          const clearSchedule = () => {
            if (window.confirm('Are you sure you want to clear the entire schedule?')) {
              setSchedule({});
            }
          };

          const clearAllData = () => {
            if (window.confirm('âš ï¸ WARNING: This will delete ALL data including classrooms, time slots, subjects, and the schedule.\n\nThis action cannot be undone. Are you sure?')) {
              if (window.confirm('Final confirmation: Delete everything?')) {
                localStorage.clear();
                setClassrooms([{ id: 1, name: 'Room 101' }, { id: 2, name: 'Room 102' }]);
                setTimeSlots([
                  { id: 1, start: '08:00', end: '09:00' },
                  { id: 2, start: '09:00', end: '10:00' },
                  { id: 3, start: '10:00', end: '11:00' },
                  { id: 4, start: '11:00', end: '12:00' }
                ]);
                setSubjects([{
                  id: 1, 
                  name: 'Mathematics', 
                  teacher: 'Mr. Smith',
                  group: 'Grade 10A',
                  color: '#3b82f6',
                  constraints: {
                    requiredDays: [],
                    requiredSlots: [],
                    requiredClassroom: null,
                    preferredDays: [],
                    preferredSlots: [],
                    preferredClassroom: null,
                    unavailableDays: [],
                    unavailableSlots: [],
                    maxPerDay: 2,
                    daysPerWeek: 1,
                    canCombineWith: [],
                  }
                }]);
                setSchedule({});
                setAiApiKey('');
                alert('All data has been cleared. Starting fresh!');
              }
            }
          };

          const callClaudeAPI = async (userMessage, systemPrompt) => {
            if (!aiApiKey) {
              setAiResponse({
                type: 'error',
                message: 'Please enter your Claude API key first. Click "âš™ï¸ API Settings" to add it.'
              });
              return null;
            }

            setAiLoading(true);
            setAiResponse(null);

            try {
              const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                  'x-api-key': aiApiKey,
                  'anthropic-version': '2023-06-01',
                  'content-type': 'application/json'
                },
                body: JSON.stringify({
                  model: 'claude-sonnet-4-5-20250929',
                  max_tokens: 4000,
                  system: systemPrompt,
                  messages: [{
                    role: 'user',
                    content: userMessage
                  }]
                })
              });

              if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API request failed');
              }

              const data = await response.json();
              setAiLoading(false);
              return data.content[0].text;
            } catch (error) {
              setAiLoading(false);
              setAiResponse({
                type: 'error',
                message: `Error: ${error.message}. Please check your API key and try again.`
              });
              return null;
            }
          };

          const handleAICommand = async () => {
            if (!aiCommand.trim()) return;

            const scheduleContext = {
              classrooms: classrooms.map(c => ({ id: c.id, name: c.name })),
              timeSlots: timeSlots.map(t => ({ id: t.id, start: t.start, end: t.end })),
              subjects: subjects.map(s => ({ 
                id: s.id, 
                name: s.name, 
                teacher: s.teacher, 
                group: s.group,
                constraints: s.constraints 
              })),
              schedule: Object.entries(schedule).map(([key, value]) => {
                const [classroomId, day, slotId] = key.split('-');
                return {
                  classroom: classrooms.find(c => c.id === parseInt(classroomId))?.name,
                  day,
                  time: timeSlots.find(t => t.id === parseInt(slotId))?.start,
                  subject: value.subjectName,
                  teacher: value.teacher
                };
              })
            };

            const systemPrompt = `You are an AI assistant for a school schedule coordinator tool. You understand Russian, English, and Georgian.

You help with:
1. Creating schedules from natural language (any language)
2. Analyzing schedules for quality and conflicts
3. Suggesting improvements
4. Understanding Russian/Georgian school context (Ñ‡ÐµÑ‚Ð²ÐµÑ€Ñ‚Ð½Ñ‹Ðµ ÐºÐ°Ð½Ð¸ÐºÑƒÐ»Ñ‹, áƒ“áƒáƒ¡áƒ•áƒ”áƒœáƒ”áƒ‘áƒ, etc.)

Current school context:
- Classrooms: ${classrooms.map(c => c.name).join(', ')}
- Time slots: ${timeSlots.map(t => t.start + '-' + t.end).join(', ')}
- Days: Monday, Tuesday, Wednesday, Thursday, Friday

IMPORTANT: Always respond with a JSON object containing:
{
  "type": "schedule" | "analysis" | "suggestion" | "info",
  "message": "Human-readable explanation in the same language as user's question",
  "actions": [array of actions to perform],
  "data": {additional data if needed}
}

For schedule creation, actions should be like:
{
  "action": "create_schedule",
  "subject": "Math",
  "teacher": "Mr. Smith", 
  "group": "Grade 10A",
  "day": "Monday",
  "classroom": "Room 101",
  "timeSlot": "08:00"
}`;

            const userMessage = `Current schedule state:
${JSON.stringify(scheduleContext, null, 2)}

User request: "${aiCommand}"

Please help with this request. Return only valid JSON.`;

            const result = await callClaudeAPI(userMessage, systemPrompt);
            
            if (result) {
              try {
                const parsed = JSON.parse(result);
                setAiResponse(parsed);
                
                // Execute actions if any
                if (parsed.actions && parsed.actions.length > 0) {
                  executeAIActions(parsed.actions);
                }
              } catch (e) {
                setAiResponse({
                  type: 'info',
                  message: result // Show raw response if not JSON
                });
              }
            }

            setAiCommand('');
          };

          const executeAIActions = (actions) => {
            actions.forEach(action => {
              if (action.action === 'create_schedule') {
                // Find or create subject
                let subject = subjects.find(s => 
                  s.name.toLowerCase() === action.subject.toLowerCase() &&
                  s.teacher.toLowerCase() === action.teacher.toLowerCase()
                );

                if (!subject) {
                  const newSubjectId = Date.now() + Math.random();
                  subject = {
                    id: newSubjectId,
                    name: action.subject,
                    teacher: action.teacher,
                    group: action.group || '',
                    color: '#' + Math.floor(Math.random()*16777215).toString(16),
                    constraints: {
                      requiredDays: [],
                      requiredSlots: [],
                      requiredClassroom: null,
                      preferredDays: [],
                      preferredSlots: [],
                      preferredClassroom: null,
                      unavailableDays: [],
                      unavailableSlots: [],
                      maxPerDay: 2,
                      daysPerWeek: 1,
                      canCombineWith: [],
                    }
                  };
                  setSubjects([...subjects, subject]);
                }

                // Find classroom and time slot
                const classroom = classrooms.find(c => 
                  c.name.toLowerCase() === action.classroom.toLowerCase()
                );
                const slot = timeSlots.find(t => 
                  t.start === action.timeSlot || 
                  t.start + '-' + t.end === action.timeSlot
                );

                if (classroom && slot && action.day) {
                  const key = getScheduleKey(classroom.id, action.day, slot.id);
                  setSchedule(prev => ({
                    ...prev,
                    [key]: {
                      subjectId: subject.id,
                      subjectName: subject.name,
                      teacher: subject.teacher,
                      group: subject.group,
                      color: subject.color
                    }
                  }));
                }
              }
            });
          };

          const analyzeSchedule = async () => {
            const scheduleStats = {
              totalClasses: Object.keys(schedule).length,
              subjectsScheduled: new Set(Object.values(schedule).map(v => v.subjectId)).size,
              totalSubjects: subjects.length,
              classroomUtilization: {}
            };

            classrooms.forEach(classroom => {
              const classCount = Object.keys(schedule).filter(key => 
                key.startsWith(classroom.id + '-')
              ).length;
              const totalSlots = DAYS.length * timeSlots.length;
              scheduleStats.classroomUtilization[classroom.name] = 
                Math.round((classCount / totalSlots) * 100);
            });

            const systemPrompt = `You are a school schedule quality analyzer. Analyze the schedule and provide:
1. Quality score (0-100)
2. Issues found (conflicts, imbalances, inefficiencies)
3. Specific recommendations for improvement
4. Consider Russian/Georgian school context if relevant

Respond in the same language as the schedule data suggests, but default to Russian if unclear.
Return JSON format with: type, score, issues, recommendations, message`;

            const result = await callClaudeAPI(
              `Analyze this schedule:\n${JSON.stringify(scheduleStats, null, 2)}\n\nSchedule details:\n${JSON.stringify(Object.entries(schedule).map(([key, value]) => {
                const [classroomId, day, slotId] = key.split('-');
                return {
                  classroom: classrooms.find(c => c.id === parseInt(classroomId))?.name,
                  day,
                  time: timeSlots.find(t => t.id === parseInt(slotId))?.start,
                  subject: value.subjectName,
                  teacher: value.teacher
                };
              }), null, 2)}`,
              systemPrompt
            );

            if (result) {
              try {
                const parsed = JSON.parse(result);
                setAiResponse(parsed);
              } catch (e) {
                setAiResponse({
                  type: 'analysis',
                  message: result
                });
              }
            }
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
              <div className="max-w-7xl mx-auto">
                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                  <h1 className="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                    <Icon name="Calendar" className="text-indigo-600" />
                    School Schedule Coordinator
                  </h1>
                  <p className="text-gray-600">Design and manage your school timetable with drag-and-drop simplicity</p>
                  <div className="mt-3 flex items-center justify-between flex-wrap gap-2">
                    <div className="flex items-center gap-2 text-sm text-green-700 bg-green-50 px-3 py-1 rounded-full">
                      <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                      Auto-save enabled - Your work is automatically saved
                    </div>
                    <button
                      onClick={clearAllData}
                      className="text-sm text-red-600 hover:text-red-800 underline"
                    >
                      Clear All Data
                    </button>
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow-lg mb-6">
                  <div className="border-b">
                    <div className="flex gap-2 p-2">
                      <button
                        onClick={() => setActiveTab('schedule')}
                        className={'px-4 py-2 rounded-t font-medium transition ' + (activeTab === 'schedule' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')}
                      >
                        Schedule Grid
                      </button>
                      <button
                        onClick={() => setActiveTab('subjects')}
                        className={'px-4 py-2 rounded-t font-medium transition ' + (activeTab === 'subjects' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')}
                      >
                        Subjects & Teachers
                      </button>
                      <button
                        onClick={() => setActiveTab('settings')}
                        className={'px-4 py-2 rounded-t font-medium transition ' + (activeTab === 'settings' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')}
                      >
                        Classrooms & Times
                      </button>
                      <button
                        onClick={() => setActiveTab('ai')}
                        className={'px-4 py-2 rounded-t font-medium transition ' + (activeTab === 'ai' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')}
                      >
                        ðŸ¤– AI Assistant
                      </button>
                    </div>
                  </div>

                  <div className="p-6">
                    {activeTab === 'schedule' && (
                      <div>
                        <div className="mb-6 flex justify-between items-center flex-wrap gap-3">
                          <div className="flex items-center gap-3">
                            <h2 className="text-xl font-bold text-gray-800">Weekly Schedule</h2>
                            <div className="flex bg-gray-200 rounded-lg p-1">
                              <button
                                onClick={() => setViewMode('grid')}
                                className={'px-3 py-1 rounded text-sm font-medium transition ' + (viewMode === 'grid' ? 'bg-white shadow' : 'text-gray-600 hover:text-gray-900')}
                              >
                                Grid View
                              </button>
                              <button
                                onClick={() => setViewMode('kanban')}
                                className={'px-3 py-1 rounded text-sm font-medium transition ' + (viewMode === 'kanban' ? 'bg-white shadow' : 'text-gray-600 hover:text-gray-900')}
                              >
                                Kanban View
                              </button>
                            </div>
                          </div>
                          <div className="flex gap-2 flex-wrap">
                            <label className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition cursor-pointer">
                              <Icon name="Upload" size={18} />
                              Import Schedule CSV
                              <input
                                type="file"
                                accept=".csv"
                                onChange={(e) => e.target.files[0] && importScheduleFromCSV(e.target.files[0])}
                                className="hidden"
                              />
                            </label>
                            <button
                              onClick={() => {
                                const result = autoSchedule();
                                alert(`Auto-scheduling complete!\n\nSuccessfully scheduled: ${result.successCount} classes\nCould not schedule: ${result.failCount} classes\n\nNote: Some subjects may need manual adjustment for optimal placement.`);
                              }}
                              className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition"
                            >
                              <Icon name="Calendar" size={18} />
                              Auto Schedule
                            </button>
                            <button
                              onClick={clearSchedule}
                              className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition"
                            >
                              <Icon name="Trash2" size={18} />
                              Clear All
                            </button>
                            <button
                              onClick={exportScheduleCSV}
                              className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition"
                            >
                              <Icon name="FileSpreadsheet" size={18} />
                              Export CSV
                            </button>
                            <button
                              onClick={exportSchedule}
                              className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition"
                            >
                              <Icon name="Download" size={18} />
                              Export JSON
                            </button>
                          </div>
                        </div>

                        <div className="mb-4 bg-purple-50 border border-purple-200 rounded-lg p-4">
                          <h3 className="font-semibold text-purple-900 mb-2 flex items-center gap-2">
                            <Icon name="Calendar" size={18} />
                            Auto-Scheduling Tips
                          </h3>
                          <ul className="text-sm text-purple-800 space-y-1">
                            <li>â€¢ The auto-scheduler prioritizes subjects with more constraints</li>
                            <li>â€¢ It respects all hard constraints (required conditions, unavailable times)</li>
                            <li>â€¢ Preferred conditions are considered but may be overridden</li>
                            <li>â€¢ You can run auto-schedule multiple times or manually adjust</li>
                            <li>â€¢ Use "Clear All" to start fresh if needed</li>
                          </ul>
                        </div>

                        <div className="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                          <h3 className="font-semibold text-blue-900 mb-2 flex items-center gap-2">
                            <Icon name="Upload" size={18} />
                            Import Schedule from Google Sheets
                          </h3>
                          <p className="text-sm text-blue-800 mb-2">
                            You can import a complete schedule from a CSV file. Create a Google Sheet with this format:
                          </p>
                          <div className="bg-white rounded p-2 font-mono text-xs overflow-x-auto mb-2">
                            <div className="font-bold">Classroom,Day,Time Slot,Subject,Teacher,Group/Class</div>
                            <div>Room 101,Monday,08:00-09:00,Mathematics,Mr. Smith,Grade 10A</div>
                            <div>Room 102,Monday,08:00-09:00,English,Ms. Johnson,Grade 10B</div>
                            <div>Room 101,Tuesday,09:00-10:00,Physics,Dr. Brown,Grade 11</div>
                          </div>
                          <ul className="text-sm text-blue-800 space-y-1">
                            <li>â€¢ <strong>Classroom</strong> must match existing classroom names exactly</li>
                            <li>â€¢ <strong>Day</strong> must be: Monday, Tuesday, Wednesday, Thursday, or Friday</li>
                            <li>â€¢ <strong>Time Slot</strong> format: 08:00-09:00 (must match your time slots)</li>
                            <li>â€¢ Subjects will be auto-created if they don't exist</li>
                            <li>â€¢ Export as CSV from Google Sheets: File â†’ Download â†’ CSV</li>
                          </ul>
                        </div>

                        <div className="mb-6 bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                          <h3 className="font-semibold text-indigo-900 mb-3">Available Subjects</h3>
                          <div className="flex flex-wrap gap-2">
                            {subjects.map(subject => {
                              const summary = getSubjectScheduleSummary(subject.id);
                              const isComplete = summary.scheduledDays >= subject.constraints.daysPerWeek;
                              const isIncomplete = summary.scheduledDays < subject.constraints.daysPerWeek;
                              
                              return (
                              <div
                                key={subject.id}
                                draggable
                                onDragStart={() => setDraggedSubject(subject)}
                                onDragEnd={() => setDraggedSubject(null)}
                                className="px-4 py-2 rounded-lg text-white font-medium cursor-move shadow-md hover:shadow-lg transition relative"
                                style={{ backgroundColor: subject.color }}
                              >
                                <div className="text-sm font-semibold">{subject.name}</div>
                                <div className="text-xs opacity-90">{subject.teacher}</div>
                                {subject.group && <div className="text-xs opacity-75">{subject.group}</div>}
                                <div className="text-xs mt-1 flex items-center gap-1">
                                  {isComplete ? (
                                    <span className="bg-green-500 bg-opacity-30 px-1 rounded">âœ“ {summary.scheduledDays}/{subject.constraints.daysPerWeek} days</span>
                                  ) : (
                                    <span className="bg-yellow-500 bg-opacity-30 px-1 rounded">âš  {summary.scheduledDays}/{subject.constraints.daysPerWeek} days</span>
                                  )}
                                </div>
                              </div>
                            )})}
                          </div>
                          <p className="text-sm text-indigo-700 mt-3">Drag subjects onto the schedule grid below</p>
                        </div>

                        {viewMode === 'grid' ? (
                          // Grid View (existing table layout)
                          <>
                        {classrooms.map(classroom => (
                          <div key={classroom.id} className="mb-8">
                            <h3 className="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                              <div className="w-3 h-3 rounded-full bg-indigo-600"></div>
                              {classroom.name}
                            </h3>
                            <div className="overflow-x-auto">
                              <table className="w-full border-collapse">
                                <thead>
                                  <tr>
                                    <th className="border border-gray-300 bg-gray-100 p-2 text-sm font-semibold text-gray-700 w-32">
                                      Time
                                    </th>
                                    {DAYS.map(day => (
                                      <th key={day} className="border border-gray-300 bg-gray-100 p-2 text-sm font-semibold text-gray-700">
                                        {day}
                                      </th>
                                    ))}
                                  </tr>
                                </thead>
                                <tbody>
                                  {timeSlots.map(slot => (
                                    <tr key={slot.id}>
                                      <td className="border border-gray-300 bg-gray-50 p-2 text-sm font-medium text-gray-700 text-center">
                                        {slot.start} - {slot.end}
                                      </td>
                                      {DAYS.map(day => {
                                        const key = getScheduleKey(classroom.id, day, slot.id);
                                        const scheduleItem = schedule[key];
                                        const result = draggedSubject ? checkConflicts(classroom.id, day, slot.id, draggedSubject.id) : { conflicts: [], warnings: [] };

                                        return (
                                          <td
                                            key={day}
                                            className={'border border-gray-300 p-2 text-sm min-h-20 relative ' + (result.conflicts.length > 0 ? 'bg-red-50' : result.warnings.length > 0 ? 'bg-yellow-50' : 'bg-white hover:bg-gray-50')}
                                            onDragOver={(e) => {
                                              e.preventDefault();
                                              if (result.conflicts.length === 0) {
                                                e.currentTarget.classList.add('bg-blue-50');
                                              }
                                            }}
                                            onDragLeave={(e) => {
                                              e.currentTarget.classList.remove('bg-blue-50');
                                            }}
                                            onDrop={(e) => {
                                              e.preventDefault();
                                              e.currentTarget.classList.remove('bg-blue-50');
                                              handleDrop(classroom.id, day, slot.id);
                                            }}
                                          >
                                            {scheduleItem ? (
                                              <div
                                                className="p-2 rounded text-white relative"
                                                style={{ backgroundColor: scheduleItem.color }}
                                              >
                                                <button
                                                  onClick={() => removeScheduleItem(classroom.id, day, slot.id)}
                                                  className="absolute top-1 right-1 bg-white bg-opacity-30 hover:bg-opacity-50 rounded p-1"
                                                >
                                                  <Icon name="Trash2" size={12} />
                                                </button>
                                                <div className="font-semibold text-sm">{scheduleItem.subjectName}</div>
                                                <div className="text-xs opacity-90">{scheduleItem.teacher}</div>
                                                {scheduleItem.group && <div className="text-xs opacity-75">{scheduleItem.group}</div>}
                                              </div>
                                            ) : result.conflicts.length > 0 && draggedSubject ? (
                                              <div className="text-xs text-red-600 p-1">
                                                <Icon name="AlertCircle" size={14} className="inline mr-1" />
                                                {result.conflicts[0]}
                                              </div>
                                            ) : result.warnings.length > 0 && draggedSubject ? (
                                              <div className="text-xs text-yellow-600 p-1">
                                                âš ï¸ Not preferred
                                              </div>
                                            ) : null}
                                          </td>
                                        );
                                      })}
                                    </tr>
                                  ))}
                                </tbody>
                              </table>
                            </div>
                          </div>
                        ))}
                        </>
                        ) : (
                          // Kanban View (by day and time slot)
                          <div className="space-y-6">
                            {/* By Day Kanban */}
                            <div>
                              <h3 className="text-lg font-bold text-gray-800 mb-3">Schedule by Day</h3>
                              <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                                {DAYS.map(day => {
                                  const daySchedule = Object.entries(schedule).filter(([key]) => {
                                    const parts = key.split('-');
                                    return parts[1] === day;
                                  });

                                  return (
                                    <div key={day} className="bg-white border-2 border-gray-200 rounded-lg p-4">
                                      <h4 className="font-bold text-gray-800 mb-3 text-center border-b pb-2">
                                        {day}
                                      </h4>
                                      <div className="space-y-2">
                                        {timeSlots.map(slot => {
                                          const slotClasses = daySchedule.filter(([key]) => {
                                            const parts = key.split('-');
                                            return parts[2] === String(slot.id);
                                          });

                                          // Find first available classroom for this day/slot or use first classroom
                                          const availableClassroom = classrooms.find(classroom => {
                                            const key = getScheduleKey(classroom.id, day, slot.id);
                                            return !schedule[key];
                                          }) || classrooms[0];

                                          const result = draggedSubject && availableClassroom ? 
                                            checkConflicts(availableClassroom.id, day, slot.id, draggedSubject.id) : 
                                            { conflicts: [], warnings: [] };

                                          return (
                                            <div 
                                              key={slot.id} 
                                              className={'border-2 border-dashed rounded p-2 min-h-16 transition ' + 
                                                (result.conflicts.length > 0 ? 'border-red-300 bg-red-50' : 
                                                 result.warnings.length > 0 ? 'border-yellow-300 bg-yellow-50' : 
                                                 draggedSubject ? 'border-blue-300 bg-blue-50' : 'border-gray-200 bg-gray-50')}
                                              onDragOver={(e) => {
                                                e.preventDefault();
                                                if (result.conflicts.length === 0) {
                                                  e.currentTarget.classList.add('border-blue-500', 'bg-blue-100');
                                                }
                                              }}
                                              onDragLeave={(e) => {
                                                e.currentTarget.classList.remove('border-blue-500', 'bg-blue-100');
                                              }}
                                              onDrop={(e) => {
                                                e.preventDefault();
                                                e.currentTarget.classList.remove('border-blue-500', 'bg-blue-100');
                                                if (availableClassroom && result.conflicts.length === 0) {
                                                  handleDrop(availableClassroom.id, day, slot.id);
                                                }
                                              }}
                                            >
                                              <div className="text-xs font-semibold text-gray-600 mb-1">
                                                {slot.start} - {slot.end}
                                              </div>
                                              {slotClasses.length > 0 ? (
                                                <div className="space-y-1">
                                                  {slotClasses.map(([key, value]) => {
                                                    const parts = key.split('-');
                                                    const classroomId = parseInt(parts[0]);
                                                    const classroom = classrooms.find(c => c.id === classroomId);
                                                    
                                                    return (
                                                      <div
                                                        key={key}
                                                        draggable
                                                        onDragStart={() => {
                                                          const subject = subjects.find(s => s.id === value.subjectId);
                                                          if (subject) {
                                                            setDraggedSubject(subject);
                                                            // Remove from current position when starting drag
                                                            setTimeout(() => removeScheduleItem(classroomId, day, slot.id), 0);
                                                          }
                                                        }}
                                                        onDragEnd={() => setDraggedSubject(null)}
                                                        className="p-2 rounded text-white text-xs relative cursor-move hover:shadow-lg transition"
                                                        style={{ backgroundColor: value.color }}
                                                      >
                                                        <button
                                                          onClick={() => removeScheduleItem(classroomId, day, slot.id)}
                                                          className="absolute top-0.5 right-0.5 bg-white bg-opacity-30 hover:bg-opacity-50 rounded p-0.5"
                                                        >
                                                          <Icon name="Trash2" size={10} />
                                                        </button>
                                                        <div className="font-semibold">{value.subjectName}</div>
                                                        <div className="opacity-90">{value.teacher}</div>
                                                        {value.group && <div className="opacity-75">{value.group}</div>}
                                                        <div className="opacity-75 mt-1">ðŸ“ {classroom?.name}</div>
                                                      </div>
                                                    );
                                                  })}
                                                </div>
                                              ) : draggedSubject && result.conflicts.length > 0 ? (
                                                <div className="text-xs text-red-600 p-1">
                                                  <Icon name="AlertCircle" size={12} className="inline mr-1" />
                                                  {result.conflicts[0]}
                                                </div>
                                              ) : draggedSubject && result.warnings.length > 0 ? (
                                                <div className="text-xs text-yellow-600 p-1 text-center">
                                                  âš ï¸ Not preferred
                                                </div>
                                              ) : draggedSubject ? (
                                                <div className="text-xs text-blue-600 italic text-center py-2">
                                                  Drop here
                                                </div>
                                              ) : (
                                                <div className="text-xs text-gray-400 italic text-center py-1">
                                                  Empty
                                                </div>
                                              )}
                                            </div>
                                          );
                                        })}
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>
                            </div>

                            {/* By Time Slot Kanban */}
                            <div>
                              <h3 className="text-lg font-bold text-gray-800 mb-3">Schedule by Time Slot</h3>
                              <div className="space-y-4">
                                {timeSlots.map(slot => {
                                  const slotSchedule = Object.entries(schedule).filter(([key]) => {
                                    const parts = key.split('-');
                                    return parts[2] === String(slot.id);
                                  });

                                  return (
                                    <div key={slot.id} className="bg-white border-2 border-gray-200 rounded-lg p-4">
                                      <h4 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                        <Icon name="Calendar" size={18} />
                                        {slot.start} - {slot.end}
                                        <span className="text-sm font-normal text-gray-600">
                                          ({slotSchedule.length} {slotSchedule.length === 1 ? 'class' : 'classes'})
                                        </span>
                                      </h4>
                                      
                                      <div className="grid grid-cols-1 md:grid-cols-5 gap-3">
                                        {DAYS.map(day => {
                                          const dayClasses = slotSchedule.filter(([key]) => {
                                            const parts = key.split('-');
                                            return parts[1] === day;
                                          });

                                          // Find first available classroom for this day/slot
                                          const availableClassroom = classrooms.find(classroom => {
                                            const key = getScheduleKey(classroom.id, day, slot.id);
                                            return !schedule[key];
                                          }) || classrooms[0];

                                          const result = draggedSubject && availableClassroom ? 
                                            checkConflicts(availableClassroom.id, day, slot.id, draggedSubject.id) : 
                                            { conflicts: [], warnings: [] };

                                          return (
                                            <div 
                                              key={day} 
                                              className={'border-2 border-dashed rounded p-2 min-h-20 transition ' + 
                                                (result.conflicts.length > 0 ? 'border-red-300 bg-red-50' : 
                                                 result.warnings.length > 0 ? 'border-yellow-300 bg-yellow-50' : 
                                                 draggedSubject ? 'border-blue-300 bg-blue-50' : 'border-gray-200 bg-gray-50')}
                                              onDragOver={(e) => {
                                                e.preventDefault();
                                                if (result.conflicts.length === 0) {
                                                  e.currentTarget.classList.add('border-blue-500', 'bg-blue-100');
                                                }
                                              }}
                                              onDragLeave={(e) => {
                                                e.currentTarget.classList.remove('border-blue-500', 'bg-blue-100');
                                              }}
                                              onDrop={(e) => {
                                                e.preventDefault();
                                                e.currentTarget.classList.remove('border-blue-500', 'bg-blue-100');
                                                if (availableClassroom && result.conflicts.length === 0) {
                                                  handleDrop(availableClassroom.id, day, slot.id);
                                                }
                                              }}
                                            >
                                              <div className="text-xs font-semibold text-gray-600 mb-2 text-center">
                                                {day}
                                              </div>
                                              {dayClasses.length > 0 ? (
                                                <div className="space-y-1">
                                                  {dayClasses.map(([key, value]) => {
                                                    const parts = key.split('-');
                                                    const classroomId = parseInt(parts[0]);
                                                    const classroom = classrooms.find(c => c.id === classroomId);
                                                    
                                                    return (
                                                      <div
                                                        key={key}
                                                        draggable
                                                        onDragStart={() => {
                                                          const subject = subjects.find(s => s.id === value.subjectId);
                                                          if (subject) {
                                                            setDraggedSubject(subject);
                                                            // Remove from current position when starting drag
                                                            setTimeout(() => removeScheduleItem(classroomId, day, slot.id), 0);
                                                          }
                                                        }}
                                                        onDragEnd={() => setDraggedSubject(null)}
                                                        className="p-2 rounded text-white text-xs relative cursor-move hover:shadow-lg transition"
                                                        style={{ backgroundColor: value.color }}
                                                      >
                                                        <button
                                                          onClick={() => removeScheduleItem(classroomId, day, slot.id)}
                                                          className="absolute top-0.5 right-0.5 bg-white bg-opacity-30 hover:bg-opacity-50 rounded p-0.5"
                                                        >
                                                          <Icon name="Trash2" size={10} />
                                                        </button>
                                                        <div className="font-semibold">{value.subjectName}</div>
                                                        <div className="opacity-90">{value.teacher}</div>
                                                        {value.group && <div className="opacity-75">{value.group}</div>}
                                                        <div className="opacity-75 mt-1">ðŸ“ {classroom?.name}</div>
                                                      </div>
                                                    );
                                                  })}
                                                </div>
                                              ) : draggedSubject && result.conflicts.length > 0 ? (
                                                <div className="text-xs text-red-600 p-1 text-center">
                                                  <Icon name="AlertCircle" size={12} className="inline mr-1" />
                                                  Conflict
                                                </div>
                                              ) : draggedSubject && result.warnings.length > 0 ? (
                                                <div className="text-xs text-yellow-600 p-1 text-center">
                                                  âš ï¸ Not preferred
                                                </div>
                                              ) : draggedSubject ? (
                                                <div className="text-xs text-blue-600 italic text-center py-2">
                                                  Drop here
                                                </div>
                                              ) : (
                                                <div className="text-xs text-gray-400 italic text-center py-2">
                                                  Free
                                                </div>
                                              )}
                                            </div>
                                          );
                                        })}
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    )}

                    {activeTab === 'subjects' && (
                      <div>
                        <div className="mb-6 flex justify-between items-center">
                          <h2 className="text-xl font-bold text-gray-800">Subjects & Teachers</h2>
                          <div className="flex gap-2">
                            <label className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition cursor-pointer">
                              <Icon name="Upload" size={18} />
                              Import CSV
                              <input
                                type="file"
                                accept=".csv"
                                onChange={(e) => e.target.files[0] && importFromCSV(e.target.files[0], 'subjects')}
                                className="hidden"
                              />
                            </label>
                            <button
                              onClick={exportSubjectsCSV}
                              className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition"
                            >
                              <Icon name="Download" size={18} />
                              Export CSV
                            </button>
                          </div>
                        </div>
                        
                        <div className="bg-gray-50 rounded-lg p-4 mb-6">
                          <h3 className="font-semibold text-gray-700 mb-3">Add New Subject</h3>
                          <div className="grid grid-cols-1 md:grid-cols-5 gap-3">
                            <input
                              type="text"
                              placeholder="Subject name"
                              value={newSubject.name}
                              onChange={(e) => setNewSubject({ ...newSubject, name: e.target.value })}
                              className="border border-gray-300 rounded px-3 py-2"
                            />
                            <input
                              type="text"
                              placeholder="Teacher name"
                              value={newSubject.teacher}
                              onChange={(e) => setNewSubject({ ...newSubject, teacher: e.target.value })}
                              className="border border-gray-300 rounded px-3 py-2"
                            />
                            <input
                              type="text"
                              placeholder="Group/Class (optional)"
                              value={newSubject.group}
                              onChange={(e) => setNewSubject({ ...newSubject, group: e.target.value })}
                              className="border border-gray-300 rounded px-3 py-2"
                            />
                            <input
                              type="color"
                              value={newSubject.color}
                              onChange={(e) => setNewSubject({ ...newSubject, color: e.target.value })}
                              className="border border-gray-300 rounded px-3 py-2 h-10"
                            />
                            <button
                              onClick={addSubject}
                              className="bg-indigo-600 text-white rounded px-4 py-2 hover:bg-indigo-700 transition flex items-center justify-center gap-2"
                            >
                              <Icon name="Plus" size={18} />
                              Add Subject
                            </button>
                          </div>
                        </div>

                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                          <h3 className="font-semibold text-blue-900 mb-2 text-sm">CSV Import Format</h3>
                          <p className="text-sm text-blue-800 mb-2">For basic import, your CSV should have these columns (first 4 are required):</p>
                          <div className="bg-white rounded p-2 font-mono text-xs overflow-x-auto">
                            <div>ID,Subject,Teacher,Group/Class,Color,Required Days,...,Max Per Day,Days Per Week,...</div>
                            <div>1,Mathematics,Mr. Smith,Grade 10A,#3b82f6,Monday;Wednesday,,,,,,,2,3,</div>
                          </div>
                          <p className="text-sm text-blue-800 mt-2">
                            <strong>Quick tip:</strong> For simple imports, just use 3 columns: Subject, Teacher, Group/Class<br/>
                            <strong>Days Per Week:</strong> Column 15 - How many different days per week this subject must be scheduled (default: 1)
                          </p>
                        </div>

                        <div className="space-y-4">
                          {subjects.map(subject => (
                            <div key={subject.id} className="border border-gray-300 rounded-lg p-4">
                              <div className="flex justify-between items-start mb-3">
                                <div className="flex items-center gap-3">
                                  <div 
                                    className="w-8 h-8 rounded"
                                    style={{ backgroundColor: subject.color }}
                                  ></div>
                                  <div>
                                    <h4 className="font-bold text-gray-800">{subject.name}</h4>
                                    <p className="text-sm text-gray-600">{subject.teacher}</p>
                                    {subject.group && <p className="text-xs text-gray-500">{subject.group}</p>}
                                  </div>
                                </div>
                                <button
                                  onClick={() => removeSubject(subject.id)}
                                  className="text-red-600 hover:text-red-800"
                                >
                                  <Icon name="Trash2" size={18} />
                                </button>
                              </div>

                              <div className="bg-gray-50 rounded p-3">
                                <button
                                  onClick={() => setEditingSubject(editingSubject === subject.id ? null : subject.id)}
                                  className="text-sm text-indigo-600 hover:text-indigo-800 font-medium mb-2"
                                >
                                  {editingSubject === subject.id ? 'âˆ’ Hide Constraints' : '+ Edit Constraints & Settings'}
                                </button>

                                {editingSubject === subject.id && (
                                  <div className="space-y-4 mt-3">
                                    <div className="bg-gray-100 border border-gray-300 rounded p-3">
                                      <h5 className="font-semibold text-gray-900 mb-2 text-sm">Basic Settings</h5>
                                      
                                      <div className="space-y-3">
                                        <div>
                                          <label className="text-sm font-medium text-gray-700 block mb-1">
                                            Subject Name:
                                          </label>
                                          <input
                                            type="text"
                                            value={subject.name}
                                            onChange={(e) => {
                                              setSubjects(subjects.map(s => 
                                                s.id === subject.id ? { ...s, name: e.target.value } : s
                                              ));
                                            }}
                                            className="border border-gray-300 rounded px-3 py-2 w-full"
                                          />
                                        </div>

                                        <div>
                                          <label className="text-sm font-medium text-gray-700 block mb-1">
                                            Teacher:
                                          </label>
                                          <input
                                            type="text"
                                            value={subject.teacher}
                                            onChange={(e) => {
                                              setSubjects(subjects.map(s => 
                                                s.id === subject.id ? { ...s, teacher: e.target.value } : s
                                              ));
                                            }}
                                            className="border border-gray-300 rounded px-3 py-2 w-full"
                                          />
                                        </div>

                                        <div>
                                          <label className="text-sm font-medium text-gray-700 block mb-1">
                                            Group/Class:
                                          </label>
                                          <input
                                            type="text"
                                            value={subject.group}
                                            onChange={(e) => {
                                              setSubjects(subjects.map(s => 
                                                s.id === subject.id ? { ...s, group: e.target.value } : s
                                              ));
                                            }}
                                            className="border border-gray-300 rounded px-3 py-2 w-full"
                                            placeholder="Optional"
                                          />
                                        </div>

                                        <div>
                                          <label className="text-sm font-medium text-gray-700 block mb-1">
                                            Color:
                                          </label>
                                          <div className="flex gap-2 items-center">
                                            <input
                                              type="color"
                                              value={subject.color}
                                              onChange={(e) => {
                                                const newColor = e.target.value;
                                                setSubjects(subjects.map(s => 
                                                  s.id === subject.id ? { ...s, color: newColor } : s
                                                ));
                                                // Update schedule items with new color
                                                const newSchedule = { ...schedule };
                                                Object.keys(newSchedule).forEach(key => {
                                                  if (newSchedule[key].subjectId === subject.id) {
                                                    newSchedule[key].color = newColor;
                                                  }
                                                });
                                                setSchedule(newSchedule);
                                              }}
                                              className="border border-gray-300 rounded px-3 py-2 h-10 w-20 cursor-pointer"
                                            />
                                            <div 
                                              className="w-24 h-10 rounded border border-gray-300 flex items-center justify-center text-white text-sm font-medium"
                                              style={{ backgroundColor: subject.color }}
                                            >
                                              Preview
                                            </div>
                                            <button
                                              onClick={() => {
                                                const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                                                setSubjects(subjects.map(s => 
                                                  s.id === subject.id ? { ...s, color: randomColor } : s
                                                ));
                                                const newSchedule = { ...schedule };
                                                Object.keys(newSchedule).forEach(key => {
                                                  if (newSchedule[key].subjectId === subject.id) {
                                                    newSchedule[key].color = randomColor;
                                                  }
                                                });
                                                setSchedule(newSchedule);
                                              }}
                                              className="text-sm text-indigo-600 hover:text-indigo-800 underline"
                                            >
                                              Random Color
                                            </button>
                                          </div>
                                        </div>
                                      </div>
                                    </div>

                                    <div className="bg-red-50 border border-red-200 rounded p-3">
                                      <h5 className="font-semibold text-red-900 mb-2 text-sm">Required Conditions (Must be met)</h5>
                                      
                                      <div className="space-y-3">
                                        <div>
                                          <label className="text-sm font-medium text-gray-700 block mb-1">
                                            Required days:
                                          </label>
                                          <div className="flex flex-wrap gap-2">
                                            {DAYS.map(day => (
                                              <label key={day} className="flex items-center gap-1">
                                                <input
                                                  type="checkbox"
                                                  checked={subject.constraints.requiredDays.includes(day)}
                                                  onChange={(e) => {
                                                    const days = e.target.checked
                                                      ? [...subject.constraints.requiredDays, day]
                                                      : subject.constraints.requiredDays.filter(d => d !== day);
                                                    updateSubjectConstraints(subject.id, {
                                                      ...subject.constraints,
                                                      requiredDays: days
                                                    });
                                                  }}
                                                  className="rounded"
                                                />
                                                <span className="text-sm">{day}</span>
                                              </label>
                                            ))}
                                          </div>
                                        </div>

                                        <div>
                                          <label className="text-sm font-medium text-gray-700 block mb-1">
                                            Required time slots:
                                          </label>
                                          <div className="flex flex-wrap gap-2">
                                            {timeSlots.map(slot => (
                                              <label key={slot.id} className="flex items-center gap-1">
                                                <input
                                                  type="checkbox"
                                                  checked={subject.constraints.requiredSlots.includes(slot.id)}
                                                  onChange={(e) => {
                                                    const slots = e.target.checked
                                                      ? [...subject.constraints.requiredSlots, slot.id]
                                                      : subject.constraints.requiredSlots.filter(s => s !== slot.id);
                                                    updateSubjectConstraints(subject.id, {
                                                      ...subject.constraints,
                                                      requiredSlots: slots
                                                    });
                                                  }}
                                                  className="rounded"
                                                />
                                                <span className="text-sm">{slot.start}-{slot.end}</span>
                                              </label>
                                            ))}
                                          </div>
                                        </div>

                                        <div>
                                          <label className="text-sm font-medium text-gray-700 block mb-1">
                                            Required classroom:
                                          </label>
                                          <select
                                            value={subject.constraints.requiredClassroom || ''}
                                            onChange={(e) => updateSubjectConstraints(subject.id, {
                                              ...subject.constraints,
                                              requiredClassroom: e.target.value ? parseInt(e.target.value) : null
                                            })}
                                            className="border border-gray-300 rounded px-3 py-1 text-sm"
                                          >
                                            <option value="">None (any classroom)</option>
                                            {classrooms.map(room => (
                                              <option key={room.id} value={room.id}>{room.name}</option>
                                            ))}
                                          </select>
                                        </div>
                                      </div>
                                    </div>

                                    <div className="bg-yellow-50 border border-yellow-200 rounded p-3">
                                      <h5 className="font-semibold text-yellow-900 mb-2 text-sm">Preferred Conditions (Warnings if not met)</h5>
                                      
                                      <div className="space-y-3">
                                        <div>
                                          <label className="text-sm font-medium text-gray-700 block mb-1">
                                            Preferred days:
                                          </label>
                                          <div className="flex flex-wrap gap-2">
                                            {DAYS.map(day => (
                                              <label key={day} className="flex items-center gap-1">
                                                <input
                                                  type="checkbox"
                                                  checked={subject.constraints.preferredDays.includes(day)}
                                                  onChange={(e) => {
                                                    const days = e.target.checked
                                                      ? [...subject.constraints.preferredDays, day]
                                                      : subject.constraints.preferredDays.filter(d => d !== day);
                                                    updateSubjectConstraints(subject.id, {
                                                      ...subject.constraints,
                                                      preferredDays: days
                                                    });
                                                  }}
                                                  className="rounded"
                                                />
                                                <span className="text-sm">{day}</span>
                                              </label>
                                            ))}
                                          </div>
                                        </div>

                                        <div>
                                          <label className="text-sm font-medium text-gray-700 block mb-1">
                                            Preferred time slots:
                                          </label>
                                          <div className="flex flex-wrap gap-2">
                                            {timeSlots.map(slot => (
                                              <label key={slot.id} className="flex items-center gap-1">
                                                <input
                                                  type="checkbox"
                                                  checked={subject.constraints.preferredSlots.includes(slot.id)}
                                                  onChange={(e) => {
                                                    const slots = e.target.checked
                                                      ? [...subject.constraints.preferredSlots, slot.id]
                                                      : subject.constraints.preferredSlots.filter(s => s !== slot.id);
                                                    updateSubjectConstraints(subject.id, {
                                                      ...subject.constraints,
                                                      preferredSlots: slots
                                                    });
                                                  }}
                                                  className="rounded"
                                                />
                                                <span className="text-sm">{slot.start}-{slot.end}</span>
                                              </label>
                                            ))}
                                          </div>
                                        </div>

                                        <div>
                                          <label className="text-sm font-medium text-gray-700 block mb-1">
                                            Preferred classroom:
                                          </label>
                                          <select
                                            value={subject.constraints.preferredClassroom || ''}
                                            onChange={(e) => updateSubjectConstraints(subject.id, {
                                              ...subject.constraints,
                                              preferredClassroom: e.target.value ? parseInt(e.target.value) : null
                                            })}
                                            className="border border-gray-300 rounded px-3 py-1 text-sm"
                                          >
                                            <option value="">None</option>
                                            {classrooms.map(room => (
                                              <option key={room.id} value={room.id}>{room.name}</option>
                                            ))}
                                          </select>
                                        </div>
                                      </div>
                                    </div>

                                    <div className="bg-blue-50 border border-blue-200 rounded p-3">
                                      <h5 className="font-semibold text-blue-900 mb-2 text-sm">Other Settings</h5>
                                      
                                      <div className="space-y-3">
                                        <div>
                                          <label className="text-sm font-medium text-gray-700 block mb-1">
                                            Unavailable days:
                                          </label>
                                          <div className="flex flex-wrap gap-2">
                                            {DAYS.map(day => (
                                              <label key={day} className="flex items-center gap-1">
                                                <input
                                                  type="checkbox"
                                                  checked={subject.constraints.unavailableDays.includes(day)}
                                                  onChange={(e) => {
                                                    const days = e.target.checked
                                                      ? [...subject.constraints.unavailableDays, day]
                                                      : subject.constraints.unavailableDays.filter(d => d !== day);
                                                    updateSubjectConstraints(subject.id, {
                                                      ...subject.constraints,
                                                      unavailableDays: days
                                                    });
                                                  }}
                                                  className="rounded"
                                                />
                                                <span className="text-sm">{day}</span>
                                              </label>
                                            ))}
                                          </div>
                                        </div>

                                        <div>
                                          <label className="text-sm font-medium text-gray-700 block mb-1">
                                            Unavailable time slots:
                                          </label>
                                          <div className="flex flex-wrap gap-2">
                                            {timeSlots.map(slot => (
                                              <label key={slot.id} className="flex items-center gap-1">
                                                <input
                                                  type="checkbox"
                                                  checked={subject.constraints.unavailableSlots.includes(slot.id)}
                                                  onChange={(e) => {
                                                    const slots = e.target.checked
                                                      ? [...subject.constraints.unavailableSlots, slot.id]
                                                      : subject.constraints.unavailableSlots.filter(s => s !== slot.id);
                                                    updateSubjectConstraints(subject.id, {
                                                      ...subject.constraints,
                                                      unavailableSlots: slots
                                                    });
                                                  }}
                                                  className="rounded"
                                                />
                                                <span className="text-sm">{slot.start}-{slot.end}</span>
                                              </label>
                                            ))}
                                          </div>
                                        </div>

                                        <div>
                                          <label className="text-sm font-medium text-gray-700 block mb-1">
                                            Max classes per day:
                                          </label>
                                          <input
                                            type="number"
                                            min="1"
                                            max="10"
                                            value={subject.constraints.maxPerDay}
                                            onChange={(e) => updateSubjectConstraints(subject.id, {
                                              ...subject.constraints,
                                              maxPerDay: parseInt(e.target.value) || 1
                                            })}
                                            className="border border-gray-300 rounded px-3 py-1 w-20"
                                          />
                                        </div>

                                        <div>
                                          <label className="text-sm font-medium text-gray-700 block mb-1">
                                            Required days per week:
                                          </label>
                                          <input
                                            type="number"
                                            min="1"
                                            max="5"
                                            value={subject.constraints.daysPerWeek}
                                            onChange={(e) => updateSubjectConstraints(subject.id, {
                                              ...subject.constraints,
                                              daysPerWeek: parseInt(e.target.value) || 1
                                            })}
                                            className="border border-gray-300 rounded px-3 py-1 w-20"
                                          />
                                          <p className="text-xs text-gray-600 mt-1">
                                            How many different days this subject must be scheduled each week
                                          </p>
                                        </div>

                                        <div>
                                          <label className="text-sm font-medium text-gray-700 block mb-1">
                                            Can combine with other groups/classes:
                                          </label>
                                          <div className="text-xs text-gray-600 mb-2">
                                            Select subjects that can be scheduled at the same time
                                          </div>
                                          <div className="flex flex-wrap gap-2">
                                            {subjects.filter(s => s.id !== subject.id).map(otherSubject => (
                                              <label key={otherSubject.id} className="flex items-center gap-1">
                                                <input
                                                  type="checkbox"
                                                  checked={subject.constraints.canCombineWith.includes(otherSubject.id)}
                                                  onChange={(e) => {
                                                    const combined = e.target.checked
                                                      ? [...subject.constraints.canCombineWith, otherSubject.id]
                                                      : subject.constraints.canCombineWith.filter(id => id !== otherSubject.id);
                                                    updateSubjectConstraints(subject.id, {
                                                      ...subject.constraints,
                                                      canCombineWith: combined
                                                    });
                                                  }}
                                                  className="rounded"
                                                />
                                                <span className="text-sm">{otherSubject.name} ({otherSubject.group || otherSubject.teacher})</span>
                                              </label>
                                            ))}
                                          </div>
                                          {subjects.filter(s => s.id !== subject.id).length === 0 && (
                                            <p className="text-sm text-gray-500 italic">No other subjects available</p>
                                          )}
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                )}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {activeTab === 'settings' && (
                      <div>
                        <div className="mb-8">
                          <div className="mb-4 flex justify-between items-center">
                            <h2 className="text-xl font-bold text-gray-800">Classrooms</h2>
                            <div className="flex gap-2">
                              <label className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition cursor-pointer text-sm">
                                <Icon name="Upload" size={16} />
                                Import CSV
                                <input
                                  type="file"
                                  accept=".csv"
                                  onChange={(e) => e.target.files[0] && importFromCSV(e.target.files[0], 'classrooms')}
                                  className="hidden"
                                />
                              </label>
                              <button
                                onClick={exportClassroomsCSV}
                                className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition text-sm"
                              >
                                <Icon name="Download" size={16} />
                                Export CSV
                              </button>
                            </div>
                          </div>
                          <div className="bg-gray-50 rounded-lg p-4 mb-4">
                            <div className="flex gap-2">
                              <input
                                type="text"
                                placeholder="Classroom name (e.g., Room 103)"
                                value={newClassroom}
                                onChange={(e) => setNewClassroom(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && addClassroom()}
                                className="flex-1 border border-gray-300 rounded px-3 py-2"
                              />
                              <button
                                onClick={addClassroom}
                                className="bg-indigo-600 text-white rounded px-4 py-2 hover:bg-indigo-700 transition flex items-center gap-2"
                              >
                                <Icon name="Plus" size={18} />
                                Add
                              </button>
                            </div>
                          </div>
                          <div className="space-y-2">
                            {classrooms.map(classroom => (
                              <div key={classroom.id} className="flex items-center justify-between bg-white border border-gray-300 rounded p-3">
                                <span className="font-medium text-gray-800">{classroom.name}</span>
                                <button
                                  onClick={() => removeClassroom(classroom.id)}
                                  className="text-red-600 hover:text-red-800"
                                >
                                  <Icon name="Trash2" size={18} />
                                </button>
                              </div>
                            ))}
                          </div>
                        </div>

                        <div>
                          <div className="mb-4 flex justify-between items-center">
                            <h2 className="text-xl font-bold text-gray-800">Time Slots</h2>
                            <div className="flex gap-2">
                              <label className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition cursor-pointer text-sm">
                                <Icon name="Upload" size={16} />
                                Import CSV
                                <input
                                  type="file"
                                  accept=".csv"
                                  onChange={(e) => e.target.files[0] && importFromCSV(e.target.files[0], 'timeSlots')}
                                  className="hidden"
                                />
                              </label>
                              <button
                                onClick={exportTimeSlotsCSV}
                                className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition text-sm"
                              >
                                <Icon name="Download" size={16} />
                                Export CSV
                              </button>
                            </div>
                          </div>
                          
                          <div className="bg-gray-50 rounded-lg p-4 mb-4">
                            <h3 className="font-semibold text-gray-700 mb-3">Add New Time Slot</h3>
                            <div className="flex gap-3 items-end">
                              <div className="flex-1">
                                <label className="text-sm font-medium text-gray-700 block mb-1">
                                  Start Time
                                </label>
                                <input
                                  type="time"
                                  value={newTimeSlot.start}
                                  onChange={(e) => setNewTimeSlot({ ...newTimeSlot, start: e.target.value })}
                                  className="border border-gray-300 rounded px-3 py-2 w-full"
                                />
                              </div>
                              <div className="flex-1">
                                <label className="text-sm font-medium text-gray-700 block mb-1">
                                  End Time
                                </label>
                                <input
                                  type="time"
                                  value={newTimeSlot.end}
                                  onChange={(e) => setNewTimeSlot({ ...newTimeSlot, end: e.target.value })}
                                  className="border border-gray-300 rounded px-3 py-2 w-full"
                                />
                              </div>
                              <button
                                onClick={addTimeSlot}
                                className="bg-indigo-600 text-white rounded px-4 py-2 hover:bg-indigo-700 transition flex items-center gap-2"
                              >
                                <Icon name="Plus" size={18} />
                                Add
                              </button>
                            </div>
                          </div>
                          
                          <div className="space-y-2">
                            {timeSlots.map(slot => (
                              <div key={slot.id} className="bg-white border border-gray-300 rounded p-3">
                                {editingTimeSlot === slot.id ? (
                                  <div className="flex gap-3 items-center">
                                    <div className="flex-1">
                                      <input
                                        type="time"
                                        defaultValue={slot.start}
                                        onChange={(e) => updateTimeSlot(slot.id, e.target.value, slot.end)}
                                        className="border border-gray-300 rounded px-3 py-2 w-full"
                                      />
                                    </div>
                                    <span className="text-gray-500">to</span>
                                    <div className="flex-1">
                                      <input
                                        type="time"
                                        defaultValue={slot.end}
                                        onChange={(e) => updateTimeSlot(slot.id, slot.start, e.target.value)}
                                        className="border border-gray-300 rounded px-3 py-2 w-full"
                                      />
                                    </div>
                                    <button
                                      onClick={() => setEditingTimeSlot(null)}
                                      className="bg-green-600 text-white rounded px-3 py-2 hover:bg-green-700 transition"
                                    >
                                      <Icon name="Check" size={18} />
                                    </button>
                                    <button
                                      onClick={() => removeTimeSlot(slot.id)}
                                      className="text-red-600 hover:text-red-800"
                                    >
                                      <Icon name="Trash2" size={18} />
                                    </button>
                                  </div>
                                ) : (
                                  <div className="flex items-center justify-between">
                                    <span className="font-medium text-gray-800">
                                      {slot.start} - {slot.end}
                                    </span>
                                    <div className="flex gap-2">
                                      <button
                                        onClick={() => setEditingTimeSlot(slot.id)}
                                        className="text-indigo-600 hover:text-indigo-800"
                                      >
                                        Edit
                                      </button>
                                      <button
                                        onClick={() => removeTimeSlot(slot.id)}
                                        className="text-red-600 hover:text-red-800"
                                      >
                                        <Icon name="Trash2" size={18} />
                                      </button>
                                    </div>
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    )}

                    {activeTab === 'ai' && (
                      <div>
                        <div className="mb-6">
                          <h2 className="text-xl font-bold text-gray-800 mb-2">ðŸ¤– AI Schedule Assistant</h2>
                          <p className="text-gray-600">
                            Ask questions in Russian, English, or Georgian. I can help schedule classes, analyze your timetable, and suggest improvements.
                          </p>
                        </div>

                        {!aiApiKey || showApiKeyInput ? (
                          <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-6 mb-6">
                            <h3 className="text-lg font-bold text-yellow-900 mb-3">âš™ï¸ Claude API Key Required</h3>
                            <p className="text-sm text-yellow-800 mb-4">
                              To use AI features, you need a Claude API key. Get $5 free credit!
                            </p>
                            <ol className="text-sm text-yellow-800 mb-4 list-decimal list-inside space-y-1">
                              <li>Go to <a href="https://console.anthropic.com/" target="_blank" className="underline font-medium">console.anthropic.com</a></li>
                              <li>Sign up and verify your email</li>
                              <li>Go to "API Keys" and create a new key</li>
                              <li>Copy the key and paste it below</li>
                            </ol>
                            <div className="flex gap-2">
                              <input
                                type="password"
                                value={aiApiKey}
                                onChange={(e) => setAiApiKey(e.target.value)}
                                placeholder="sk-ant-api03-..."
                                className="flex-1 border border-gray-300 rounded px-3 py-2 font-mono text-sm"
                              />
                              <button
                                onClick={() => {
                                  if (aiApiKey) {
                                    setShowApiKeyInput(false);
                                    alert('API key saved! You can now use AI features.');
                                  }
                                }}
                                className="bg-green-600 text-white rounded px-4 py-2 hover:bg-green-700 transition"
                              >
                                Save Key
                              </button>
                            </div>
                            <p className="text-xs text-yellow-700 mt-2">
                              ðŸ”’ Your API key is stored locally in your browser and never sent anywhere except to Claude API.
                            </p>
                          </div>
                        ) : (
                          <div className="bg-green-50 border border-green-200 rounded-lg p-3 mb-4 flex justify-between items-center">
                            <span className="text-sm text-green-800">âœ… API key configured</span>
                            <button
                              onClick={() => setShowApiKeyInput(true)}
                              className="text-sm text-green-700 hover:text-green-900 underline"
                            >
                              Change Key
                            </button>
                          </div>
                        )}

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
                          <button
                            onClick={analyzeSchedule}
                            disabled={!aiApiKey || aiLoading}
                            className="bg-blue-600 text-white rounded-lg p-4 hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                          >
                            <div className="text-lg font-bold">ðŸ“Š Analyze Schedule</div>
                            <div className="text-sm opacity-90">Get quality score & suggestions</div>
                          </button>
                          <button
                            onClick={() => setAiCommand('ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð´Ð»Ñ Ð»ÑƒÑ‡ÑˆÐµÐ¹ ÐºÐ¾Ð½Ñ†ÐµÐ½Ñ‚Ñ€Ð°Ñ†Ð¸Ð¸ ÑƒÑ‡ÐµÐ½Ð¸ÐºÐ¾Ð²')}
                            disabled={!aiApiKey || aiLoading}
                            className="bg-purple-600 text-white rounded-lg p-4 hover:bg-purple-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                          >
                            <div className="text-lg font-bold">âš¡ Optimize</div>
                            <div className="text-sm opacity-90">Improve schedule quality</div>
                          </button>
                          <button
                            onClick={() => setAiCommand('ÐšÐ°ÐºÐ¸Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ð² Ð¼Ð¾Ñ‘Ð¼ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ð¸?')}
                            disabled={!aiApiKey || aiLoading}
                            className="bg-orange-600 text-white rounded-lg p-4 hover:bg-orange-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                          >
                            <div className="text-lg font-bold">ðŸ” Find Issues</div>
                            <div className="text-sm opacity-90">Detect conflicts & problems</div>
                          </button>
                        </div>

                        <div className="bg-white border-2 border-gray-200 rounded-lg p-4 mb-4">
                          <h3 className="font-semibold text-gray-800 mb-3">ðŸ’¬ Ask AI Assistant</h3>
                          <div className="flex gap-2 mb-3">
                            <input
                              type="text"
                              value={aiCommand}
                              onChange={(e) => setAiCommand(e.target.value)}
                              onKeyPress={(e) => e.key === 'Enter' && !aiLoading && handleAICommand()}
                              placeholder="Ð—Ð°Ð¿Ð»Ð°Ð½Ð¸Ñ€ÑƒÐ¹ Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÑƒ Ð½Ð° Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº ÑƒÑ‚Ñ€Ð¾Ð¼..."
                              className="flex-1 border border-gray-300 rounded px-4 py-3"
                              disabled={!aiApiKey || aiLoading}
                            />
                            <button
                              onClick={handleAICommand}
                              disabled={!aiApiKey || aiLoading || !aiCommand.trim()}
                              className="bg-indigo-600 text-white rounded px-6 py-3 hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed font-medium"
                            >
                              {aiLoading ? 'Thinking...' : 'Send'}
                            </button>
                          </div>
                          <div className="text-xs text-gray-600">
                            <strong>Examples:</strong> "Ð—Ð°Ð¿Ð»Ð°Ð½Ð¸Ñ€ÑƒÐ¹ Ñ„Ð¸Ð·Ð¸ÐºÑƒ Ð½Ð° Ð²Ñ‚Ð¾Ñ€Ð½Ð¸Ðº Ð² Lab A" â€¢ "Schedule Math every Monday morning" â€¢ "áƒ“áƒáƒ’áƒ”áƒ’áƒ›áƒ” áƒ¥áƒ˜áƒ›áƒ˜áƒ áƒáƒ—áƒ®áƒ¨áƒáƒ‘áƒáƒ—áƒ¡"
                          </div>
                        </div>

                        {aiLoading && (
                          <div className="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
                            <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div>
                            <div className="text-blue-800 font-medium">AI is thinking...</div>
                          </div>
                        )}

                        {aiResponse && (
                          <div className={`border-2 rounded-lg p-6 ${
                            aiResponse.type === 'error' ? 'bg-red-50 border-red-300' :
                            aiResponse.type === 'analysis' ? 'bg-blue-50 border-blue-300' :
                            'bg-green-50 border-green-300'
                          }`}>
                            <h3 className="font-bold text-lg mb-3">
                              {aiResponse.type === 'error' ? 'âŒ Error' :
                               aiResponse.type === 'analysis' ? 'ðŸ“Š Analysis Results' :
                               aiResponse.type === 'suggestion' ? 'ðŸ’¡ Suggestions' :
                               'âœ… Response'}
                            </h3>
                            <div className="whitespace-pre-wrap text-gray-800">
                              {aiResponse.message}
                            </div>
                            {aiResponse.score && (
                              <div className="mt-4 p-4 bg-white rounded border border-gray-200">
                                <div className="text-2xl font-bold text-center mb-2">
                                  Quality Score: {aiResponse.score}/100
                                </div>
                                <div className="w-full bg-gray-200 rounded-full h-3">
                                  <div 
                                    className={`h-3 rounded-full ${
                                      aiResponse.score >= 80 ? 'bg-green-500' :
                                      aiResponse.score >= 60 ? 'bg-yellow-500' :
                                      'bg-red-500'
                                    }`}
                                    style={{ width: aiResponse.score + '%' }}
                                  ></div>
                                </div>
                              </div>
                            )}
                            {aiResponse.issues && aiResponse.issues.length > 0 && (
                              <div className="mt-4">
                                <h4 className="font-semibold mb-2">Issues Found:</h4>
                                <ul className="list-disc list-inside space-y-1">
                                  {aiResponse.issues.map((issue, i) => (
                                    <li key={i} className="text-gray-700">{issue}</li>
                                  ))}
                                </ul>
                              </div>
                            )}
                            {aiResponse.recommendations && aiResponse.recommendations.length > 0 && (
                              <div className="mt-4">
                                <h4 className="font-semibold mb-2">Recommendations:</h4>
                                <ul className="list-disc list-inside space-y-1">
                                  {aiResponse.recommendations.map((rec, i) => (
                                    <li key={i} className="text-gray-700">{rec}</li>
                                  ))}
                                </ul>
                              </div>
                            )}
                          </div>
                        )}

                        <div className="mt-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
                          <h3 className="font-semibold text-gray-800 mb-2">ðŸŽ“ What can AI help with?</h3>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-700">
                            <div>
                              <strong>Scheduling:</strong>
                              <ul className="list-disc list-inside ml-2 mt-1">
                                <li>Natural language commands</li>
                                <li>Bulk schedule creation</li>
                                <li>Smart constraint setup</li>
                              </ul>
                            </div>
                            <div>
                              <strong>Analysis:</strong>
                              <ul className="list-disc list-inside ml-2 mt-1">
                                <li>Quality scoring</li>
                                <li>Conflict detection</li>
                                <li>Optimization suggestions</li>
                              </ul>
                            </div>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          );
        }

        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function() {
            ReactDOM.render(React.createElement(SchoolScheduler), document.getElementById('root'));
          });
        } else {
          ReactDOM.render(React.createElement(SchoolScheduler), document.getElementById('root'));
        }
    </script>
</body>
</html>